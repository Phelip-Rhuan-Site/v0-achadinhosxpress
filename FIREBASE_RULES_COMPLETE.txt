===========================================
REGRAS DO FIRESTORE (Firestore Database > Rules)
===========================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função para verificar se o usuário é admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/invites/$(request.auth.token.email)) &&
             (get(/databases/$(database)/documents/invites/$(request.auth.token.email)).data.role == 'ADM Master' ||
              get(/databases/$(database)/documents/invites/$(request.auth.token.email)).data.role == 'admin' ||
              ('role' in get(/databases/$(database)/documents/invites/$(request.auth.token.email)).data &&
               get(/databases/$(database)/documents/invites/$(request.auth.token.email)).data.role.matches('.*ADM.*')));
    }

    // Produtos: leitura pública, escrita apenas admin
    match /products/{productId} {
      allow read: if true;
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Meta (configurações públicas do site): leitura pública, escrita apenas admin
    match /meta/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Config (configurações internas): apenas admin
    match /config/{document} {
      allow read, write: if isAdmin();
    }

    // Usuários: cada usuário pode ler/escrever apenas seus próprios dados
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Invites (convites de admin): usuários podem ler seu próprio convite, admins podem ler todos
    match /invites/{email} {
      allow read: if request.auth != null && 
                     (request.auth.token.email == email || isAdmin());
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }

    // Pedidos: usuários podem ler seus próprios pedidos, admins podem ler todos
    match /orders/{orderId} {
      allow read: if request.auth != null && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if request.auth != null;
      allow update, delete: if isAdmin();
    }

    // Carrinho: usuários podem gerenciar apenas seu próprio carrinho
    match /carts/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Categorias: leitura pública, escrita apenas admin
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Reviews/Avaliações: leitura pública, usuários autenticados podem criar, apenas autor ou admin pode editar/deletar
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && 
                               (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Bloquear acesso a qualquer outra coleção não especificada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

===========================================
REGRAS DO STORAGE (Storage > Rules)
===========================================

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Função para verificar se é admin
    function isAdmin() {
      return request.auth != null &&
             firestore.get(/databases/(default)/documents/invites/$(request.auth.token.email)).data.role.matches('.*ADM.*');
    }
    
    // Pasta de configurações (logos, banners, etc)
    match /config/{allPaths=**} {
      allow read: if true; // Qualquer um pode ler
      allow write: if isAdmin(); // Apenas admin pode fazer upload
    }
    
    // Pasta de produtos (imagens de produtos)
    match /products/{allPaths=**} {
      allow read: if true; // Qualquer um pode ler
      allow write: if isAdmin(); // Apenas admin pode fazer upload
    }
    
    // Pasta de usuários (fotos de perfil, etc)
    match /users/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Bloquear acesso a qualquer outra pasta
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

===========================================
COMO APLICAR AS REGRAS
===========================================

1. FIRESTORE:
   - Vá para Firebase Console > Firestore Database
   - Clique na aba "Rules"
   - Copie e cole a seção "REGRAS DO FIRESTORE" acima
   - Clique em "Publicar"

2. STORAGE:
   - Vá para Firebase Console > Storage
   - Clique na aba "Rules"
   - Copie e cole a seção "REGRAS DO STORAGE" acima
   - Clique em "Publicar"

3. CORS (se ainda tiver problemas):
   - Instale o Google Cloud SDK
   - Crie um arquivo cors.json com:
   
   [
     {
       "origin": ["https://achadinhosxpress.netlify.app", "http://localhost:3000"],
       "method": ["GET", "POST", "PUT", "DELETE"],
       "maxAgeSeconds": 3600
     }
   ]
   
   - Execute: gsutil cors set cors.json gs://achadinhos-xpress.firebasestorage.app

===========================================
